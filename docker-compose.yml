version: '3.9'

services:
  # Servicio para Base de Datos Postgres 
  db:
    image: postgres:12.7
    container_name: postgres_12.7
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: imdb-movies
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./initdb:/docker-entrypoint-initdb.d
    # healthcheck:
    #   test: ["CMD-SHELL", "pg_isready -d imdb-movies -U user -h db"]
    #   interval: 10s
    #   timeout: 5s
    #   retries: 5

  # Servicio para carga de datos en DB 
  data_loader:
    build:
      context: .
      dockerfile: data_loader.dockerfile
    container_name: data_loader
    # depends_on:
      # - db
      # db:
      #   condition: service_healthy
    volumes:
      - ./files:/files
      - ./logs:/logs
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: imdb-movies
      POSTGRES_HOST: db  # Nombre del servicio en docker-compose
    command: ["sh", "-c", "python populate_db.py > /logs/populate_db.log 2>&1"]
    restart: on-failure
    deploy:
      resources:
        limits:
          memory: 4G  
          cpus: '2.0'  

  # Servicio para Reporte de Consultas 
  data_report:
    build:
      context: .
      dockerfile: queries.dockerfile
    container_name: data_report
    depends_on:
      data_loader:
        condition: service_completed_successfully
    volumes:
      - ./logs:/logs
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: imdb-movies
      POSTGRES_HOST: db
    command: ["sh", "-c", "python report_queries.py > /logs/report_queries.log 2>&1"]
    restart: on-failure

volumes:
  postgres_data:
